<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body class="bg-gray-100 font-sans">

    <!-- Main Container -->
    <div id="admin-panel" class="container mx-auto p-4 max-w-4xl">
        <header class="bg-indigo-600 text-white p-4 rounded-lg shadow-md mb-6 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-center">Admin Panel</h1>
            <button id="sign-out-btn" class="hidden bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">
                Sign Out
            </button>
        </header>
        
        <!-- Admin Login with Google -->
        <div id="admin-login" class="bg-white p-8 rounded-lg shadow-md max-w-md mx-auto text-center">
             <h2 class="text-2xl font-bold mb-6 text-gray-700">Admin Login</h2>
             <p class="text-gray-600 mb-6">Jaari rakhne ke liye kripya apne Google account se sign in karein.</p>
             <button id="google-login-btn" class="bg-white border border-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-lg shadow-sm hover:bg-gray-50 transition duration-300 flex items-center justify-center w-full">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" class="w-6 h-6 mr-3">
                Google Se Sign in Karein
             </button>
        </div>

        <!-- Access Denied Message -->
        <div id="access-denied" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative max-w-md mx-auto text-center" role="alert">
            <strong class="font-bold">Access Denied!</strong>
            <span class="block sm:inline">Yeh Google account admin panel ke liye authorized nahi hai.</span>
        </div>

        <!-- Admin Content Management (Hidden by default) -->
        <div id="admin-content" class="hidden">
            <!-- General Settings -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">General Settings</h2>
                <div class="space-y-4">
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-4">
                        <label for="timer-duration-setting" class="font-medium text-gray-700 w-52 shrink-0">Wait Timer (seconds):</label>
                        <input type="number" id="timer-duration-setting" value="10" min="0" class="w-24 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <button id="save-settings-btn" class="bg-indigo-500 text-white px-6 py-2 rounded-md hover:bg-indigo-600 font-semibold flex items-center justify-center gap-2 mt-2">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                </div>
            </div>

            <!-- Ad Management -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Manage Banner Ads</h2>
                <div class="space-y-4">
                    <div>
                        <label for="ad-slot-1" class="font-medium text-gray-700 block mb-1">Ad Slot 1 Code (Header ke neeche):</label>
                        <textarea id="ad-slot-1" rows="4" placeholder="Adsterra ad code yahan paste karein..." class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 font-mono text-sm"></textarea>
                    </div>
                    <div>
                        <label for="ad-slot-2" class="font-medium text-gray-700 block mb-1">Ad Slot 2 Code (Slider ke neeche):</label>
                        <textarea id="ad-slot-2" rows="4" placeholder="Adsterra ad code yahan paste karein..." class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 font-mono text-sm"></textarea>
                    </div>
                    <div>
                        <label for="ad-slot-3" class="font-medium text-gray-700 block mb-1">Ad Slot 3 Code (Footer mein):</label>
                        <textarea id="ad-slot-3" rows="4" placeholder="Adsterra ad code yahan paste karein..." class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 font-mono text-sm"></textarea>
                    </div>
                    <button id="save-ads-btn" class="bg-teal-500 text-white px-6 py-2 rounded-md hover:bg-teal-600 font-semibold flex items-center justify-center gap-2 mt-2">
                        <i class="fas fa-save"></i> Save Ad Codes
                    </button>
                </div>
            </div>

            <!-- Slider Management -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Manage Slider Banners</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <input type="url" id="slider-image-url" placeholder="Slider Image URL" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                     <input type="url" id="slider-link-url" placeholder="Destination Link URL (Optional)" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <button id="add-slider-btn" class="mt-4 w-full bg-green-500 text-white px-6 py-2 rounded-md hover:bg-green-600 font-semibold flex items-center justify-center gap-2">
                    <i class="fas fa-plus"></i> Add Slider
                </button>
                <div id="slider-list" class="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                    <!-- Slider images will be listed here -->
                </div>
            </div>

            <!-- File Management -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Manage Files</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="text" id="file-title" placeholder="File Title" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="number" id="file-ad-count" placeholder="Ads to Unlock" value="10" min="1" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="url" id="file-thumbnail-url" placeholder="Thumbnail Image URL" class="p-2 border rounded-md md:col-span-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <textarea id="file-description" placeholder="File Description" class="p-2 border rounded-md md:col-span-2 h-24 focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    <input type="url" id="file-download-url" placeholder="Actual File Download URL" class="p-2 border rounded-md md:col-span-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <button id="add-file-btn" class="w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600 font-semibold flex items-center justify-center gap-2">
                    <i class="fas fa-upload"></i> Add File
                </button>
                <div id="file-list" class="mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Files will be listed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Edit File Modal -->
    <div id="edit-file-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-xl leading-6 font-medium text-gray-900 text-center mb-4">Edit File Details</h3>
                <div class="mt-2 px-7 py-3 space-y-4">
                     <input type="hidden" id="edit-file-id">
                     <input type="text" id="edit-file-title" placeholder="File Title" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                     <input type="number" id="edit-file-ad-count" placeholder="Ads to Unlock" min="1" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                     <input type="url" id="edit-file-thumbnail-url" placeholder="Thumbnail Image URL" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                     <textarea id="edit-file-description" placeholder="File Description" class="w-full p-2 border rounded-md h-24 focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                     <input type="url" id="edit-file-download-url" placeholder="Actual File Download URL" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="flex justify-end items-center px-4 py-3 gap-2">
                    <button id="cancel-edit-btn" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Cancel
                    </button>
                    <button id="save-edit-btn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300">
        <p id="toast-message"></p>
    </div>

    <!-- Firebase and App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, serverTimestamp, query, orderBy, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
  apiKey: "AIzaSyDY2k2G_ew_tC83NAS1EJmaS_cRMHYd_P0",
  authDomain: "dip-download-c57f0.firebaseapp.com",
  databaseURL: "https://dip-download-c57f0-default-rtdb.firebaseio.com",
  projectId: "dip-download-c57f0",
  storageBucket: "dip-download-c57f0.firebasestorage.app",
  messagingSenderId: "147900607669",
  appId: "1:147900607669:web:78cc03e75c7dfdba8e22fc"
};
        
        const authorizedAdmins = ['dipr95229@gmail.com'];

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // DOM elements
        const adminLogin = document.getElementById('admin-login');
        const adminContent = document.getElementById('admin-content');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const signOutBtn = document.getElementById('sign-out-btn');
        const accessDenied = document.getElementById('access-denied');
        const fileList = document.getElementById('file-list');
        const sliderList = document.getElementById('slider-list');
        const editModal = document.getElementById('edit-file-modal');

        onAuthStateChanged(auth, (user) => {
            if (user && authorizedAdmins.includes(user.email)) {
                adminLogin.classList.add('hidden');
                accessDenied.classList.add('hidden');
                adminContent.classList.remove('hidden');
                signOutBtn.classList.remove('hidden');
                loadAdminData();
            } else {
                adminLogin.classList.remove('hidden');
                adminContent.classList.add('hidden');
                signOutBtn.classList.add('hidden');
                if (user) accessDenied.classList.remove('hidden');
            }
        });

        googleLoginBtn.addEventListener('click', () => signInWithPopup(auth, provider));
        signOutBtn.addEventListener('click', () => signOut(auth));

        // --- NEW: Improved Toast and Button Handling ---

        function showToast(message, type = 'default') {
            const toast = document.getElementById('toast');
            toast.querySelector('#toast-message').textContent = message;
            toast.classList.remove('bg-gray-800', 'bg-green-600', 'bg-red-500'); // Remove old colors
            
            if (type === 'success') {
                toast.classList.add('bg-green-600');
            } else if (type === 'error') {
                toast.classList.add('bg-red-500');
            } else {
                toast.classList.add('bg-gray-800');
            }

            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 3000);
        }

        async function handleAsyncButton(button, asyncOperation) {
            const originalHtml = button.innerHTML;
            button.disabled = true;
            button.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Saving...`;
            try {
                await asyncOperation();
                button.innerHTML = `<i class="fas fa-check-circle mr-2"></i> Saved!`;
            } catch (error) {
                console.error("Operation failed:", error);
                button.innerHTML = `<i class="fas fa-times-circle mr-2"></i> Error!`;
                showToast('Operation failed. Check console for details.', 'error');
            } finally {
                setTimeout(() => {
                    button.innerHTML = originalHtml;
                    button.disabled = false;
                }, 2000);
            }
        }

        async function loadAdminData() {
            await loadAdminSettings();
            await loadAdminAds();
            await loadAdminSliders();
            await loadAdminFiles();
        }

        // --- Settings Management ---
        const timerDurationInput = document.getElementById('timer-duration-setting');
        document.getElementById('save-settings-btn').addEventListener('click', (e) => {
            const duration = parseInt(timerDurationInput.value);
            if (duration < 0) {
                return showToast("Timer 0 se kam nahi ho sakta.", 'error');
            }
            handleAsyncButton(e.currentTarget, async () => {
                await setDoc(doc(db, "settings", "general"), { timerDuration: duration });
                showToast("Settings save ho gayi!", 'success');
            });
        });

        async function loadAdminSettings() {
            const docSnap = await getDoc(doc(db, "settings", "general"));
            timerDurationInput.value = docSnap.exists() ? docSnap.data().timerDuration : 10;
        }
        
        // --- Ad Management ---
        const adSlot1Input = document.getElementById('ad-slot-1');
        const adSlot2Input = document.getElementById('ad-slot-2');
        const adSlot3Input = document.getElementById('ad-slot-3');

        document.getElementById('save-ads-btn').addEventListener('click', (e) => {
            const adData = {
                adSlot1: adSlot1Input.value,
                adSlot2: adSlot2Input.value,
                adSlot3: adSlot3Input.value,
            };
            handleAsyncButton(e.currentTarget, async () => {
                await setDoc(doc(db, "settings", "ads"), adData);
                showToast("Ad codes save ho gaye!", 'success');
            });
        });

        async function loadAdminAds() {
            const docRef = doc(db, "settings", "ads");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const adData = docSnap.data();
                adSlot1Input.value = adData.adSlot1 || '';
                adSlot2Input.value = adData.adSlot2 || '';
                adSlot3Input.value = adData.adSlot3 || '';
            }
        }

        // --- Slider Management ---
        document.getElementById('add-slider-btn').addEventListener('click', (e) => {
            const imageUrl = document.getElementById('slider-image-url').value;
            if (!imageUrl) return showToast("Slider Image URL zaroori hai.", 'error');
            const linkUrl = document.getElementById('slider-link-url').value;
            
            handleAsyncButton(e.currentTarget, async () => {
                await addDoc(collection(db, "sliders"), { imageUrl, linkUrl: linkUrl || "", createdAt: serverTimestamp() });
                showToast("Slider add ho gaya!", 'success');
                document.getElementById('slider-image-url').value = '';
                document.getElementById('slider-link-url').value = '';
                loadAdminSliders();
            });
        });

        async function loadAdminSliders() {
            sliderList.innerHTML = '<p class="col-span-full text-center">Loading...</p>';
            const q = query(collection(db, "sliders"), orderBy("createdAt", "desc"));
            const querySnapshot = await getDocs(q);
            sliderList.innerHTML = '';
            querySnapshot.forEach((doc) => {
                const slider = doc.data();
                const sliderEl = document.createElement('div');
                sliderEl.className = 'relative group';
                sliderEl.innerHTML = `
                    <img src="${slider.imageUrl}" class="w-full h-24 object-cover rounded-md border">
                    <p class="text-xs truncate text-center p-1">${slider.linkUrl || 'No link'}</p>
                    <button data-id="${doc.id}" class="delete-slider-btn absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100">&times;</button>
                `;
                sliderList.appendChild(sliderEl);
            });
        }
        
        sliderList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-slider-btn')) {
                if (confirm("Kya aap ise delete karna chahte hain?")) {
                    await deleteDoc(doc(db, "sliders", e.target.dataset.id));
                    showToast("Slider delete ho gaya.", 'success');
                    loadAdminSliders();
                }
            }
        });

        // --- File Management ---
        document.getElementById('add-file-btn').addEventListener('click', (e) => {
            const title = document.getElementById('file-title').value;
            const thumbnailUrl = document.getElementById('file-thumbnail-url').value;
            const description = document.getElementById('file-description').value;
            const downloadUrl = document.getElementById('file-download-url').value;
            const requiredAds = parseInt(document.getElementById('file-ad-count').value);

            if (!title || !thumbnailUrl || !description || !downloadUrl || !requiredAds) return showToast("Kripya sabhi file fields bharein.", 'error');
            if (requiredAds <= 0) return showToast("Ads 0 se zyada hone chahiye.", 'error');
            
            handleAsyncButton(e.currentTarget, async () => {
                await addDoc(collection(db, "files"), { title, thumbnailUrl, description, downloadUrl, requiredAds, createdAt: serverTimestamp() });
                showToast("File add ho gayi!", 'success');
                ['file-title', 'file-thumbnail-url', 'file-description', 'file-download-url'].forEach(id => document.getElementById(id).value = '');
                document.getElementById('file-ad-count').value = 10;
                loadAdminFiles();
            });
        });

        async function loadAdminFiles() {
            fileList.innerHTML = '<p class="col-span-full text-center">Loading...</p>';
            const q = query(collection(db, "files"), orderBy("createdAt", "desc"));
            const querySnapshot = await getDocs(q);
            fileList.innerHTML = '';
            querySnapshot.forEach((doc) => {
                const file = doc.data();
                const fileEl = document.createElement('div');
                fileEl.className = 'bg-gray-50 p-4 rounded-lg shadow-sm border';
                fileEl.innerHTML = `
                    <img src="${file.thumbnailUrl}" class="w-full h-32 object-cover rounded-md mb-2">
                    <h3 class="font-bold text-md">${file.title}</h3>
                    <p class="text-sm text-gray-600 truncate my-1">${file.description}</p>
                    <p class="text-sm font-semibold text-gray-800 mt-2">Ads to Unlock: ${file.requiredAds || 'N/A'}</p>
                    <div class="flex gap-2 mt-2">
                         <button data-id="${doc.id}" class="edit-file-btn w-full bg-yellow-500 text-white py-1 rounded-md hover:bg-yellow-600 font-semibold flex items-center justify-center gap-2">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button data-id="${doc.id}" class="delete-file-btn w-full bg-red-500 text-white py-1 rounded-md hover:bg-red-600 font-semibold flex items-center justify-center gap-2">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;
                fileList.appendChild(fileEl);
            });
        }
        
        fileList.addEventListener('click', async (e) => {
            const deleteBtn = e.target.closest('.delete-file-btn');
            const editBtn = e.target.closest('.edit-file-btn');

            if (deleteBtn) {
                if (confirm("Kya aap is file ko delete karna chahte hain?")) {
                    await deleteDoc(doc(db, "files", deleteBtn.dataset.id));
                    showToast("File delete ho gayi.", 'success');
                    loadAdminFiles();
                }
            } else if (editBtn) {
                const fileId = editBtn.dataset.id;
                const fileRef = doc(db, "files", fileId);
                const docSnap = await getDoc(fileRef);
                if (docSnap.exists()) {
                    const fileData = docSnap.data();
                    document.getElementById('edit-file-id').value = fileId;
                    document.getElementById('edit-file-title').value = fileData.title;
                    document.getElementById('edit-file-ad-count').value = fileData.requiredAds;
                    document.getElementById('edit-file-thumbnail-url').value = fileData.thumbnailUrl;
                    document.getElementById('edit-file-description').value = fileData.description;
                    document.getElementById('edit-file-download-url').value = fileData.downloadUrl;
                    editModal.classList.remove('hidden');
                }
            }
        });

        // --- Edit Modal Logic ---
        document.getElementById('cancel-edit-btn').addEventListener('click', () => {
            editModal.classList.add('hidden');
        });

        document.getElementById('save-edit-btn').addEventListener('click', (e) => {
            const fileId = document.getElementById('edit-file-id').value;
            const updatedData = {
                title: document.getElementById('edit-file-title').value,
                requiredAds: parseInt(document.getElementById('edit-file-ad-count').value),
                thumbnailUrl: document.getElementById('edit-file-thumbnail-url').value,
                description: document.getElementById('edit-file-description').value,
                downloadUrl: document.getElementById('edit-file-download-url').value
            };

            if (!updatedData.title || !updatedData.thumbnailUrl || !updatedData.description || !updatedData.downloadUrl || !updatedData.requiredAds) {
                return showToast("Kripya sabhi fields bharein.", 'error');
            }
            if (updatedData.requiredAds <= 0) {
                return showToast("Ads 0 se zyada hone chahiye.", 'error');
            }
            
            handleAsyncButton(e.currentTarget, async () => {
                const fileRef = doc(db, "files", fileId);
                await updateDoc(fileRef, updatedData);
                showToast("File safaltapoorvak update ho gayi!", 'success');
                editModal.classList.add('hidden');
                loadAdminFiles();
            });
        });

    </script>
</body>
</html>ap.val() || 0);
            const maxEarning = Math.max(...earningsData, 1);
            earningsData.forEach((earning, index) => {
                const height = (earning / maxEarning) * 100;
                const dateLabel = new Date(dates[index]).toLocaleDateString('en-US', { day: 'numeric' });
                chartEl.innerHTML += `<div class="bar" style="height: ${height}%;"><span class="tooltip">${earning.toFixed(2)} TK</span></div>`;
                labelsEl.innerHTML += `<span>${dateLabel}</span>`;
            });
        };
        
        const handleWatchAd = async () => {
            if (userState.dailyAdCount >= appConfig.dailyAdLimit) { tg.showAlert("You have reached your daily ad watch limit."); return; }
            const now = Date.now();
            if (userState.breakUntil && now < userState.breakUntil) {
                const remaining = Math.ceil((userState.breakUntil - now) / 60000);
                tg.showAlert(`Please wait for ${remaining} more minutes.`); return;
            }
            
            const adFunction = window['show_' + appConfig.adZoneId];
            if (typeof adFunction !== 'function') {
                tg.showAlert("Ad network is not ready yet. Please wait a few seconds and try again."); return;
            }

            showPopup(`<div class="popup-loader"><div class="spinner"></div></div><h2>Loading Ad</h2><p>Please wait a moment...</p>`);
            
            try {
                await adFunction();
                closePopup();
                const adValue = appConfig.adValue || 0;
                
                earningWalletBalance += adValue;
                localStorage.setItem(`earningWallet_${tgUser.id}`, earningWalletBalance.toString());

                userState.dailyAdCount++;
                userState.lifetimeAdCount++;
                userState.totalEarned = (userState.totalEarned || 0) + adValue;

                const db = firebase.database(); const userRef = db.ref(`users/${tgUser.id}`);
                const updates = {};
                updates.dailyAdCount = userState.dailyAdCount;
                updates.lifetimeAdCount = userState.lifetimeAdCount;
                updates.totalEarned = userState.totalEarned;
                if ((userState.dailyAdCount) % appConfig.adsPerBreak === 0 && appConfig.adsPerBreak > 0) {
                    updates.breakUntil = Date.now() + (appConfig.breakDuration * 60000);
                    userState.breakUntil = updates.breakUntil;
                }
                await userRef.update(updates);
                
                const today = new Date().toISOString().slice(0, 10);
                await db.ref(`userEarnings/${tgUser.id}/${today}`).set(firebase.database.ServerValue.increment(adValue));

                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert(`+${adValue.toFixed(2)} TK added to your Earning Wallet.`);
                
                renderUI();

            } catch (error) {
                console.error("Ad failed to load:", error);
                closePopup();
                tg.showAlert("Ad could not be loaded. Please try again.");
            }
        };

        const handleMoveToBalance = async () => {
            if(earningWalletBalance < 100) { tg.showAlert("You need at least 100 TK to move."); return; }
            const btn = document.getElementById('move-to-balance-btn'); btn.disabled = true; btn.textContent = 'Moving...';
            try {
                const db = firebase.database();
                await db.ref(`users/${tgUser.id}/balance`).set(firebase.database.ServerValue.increment(earningWalletBalance));
                userState.balance += earningWalletBalance;
                earningWalletBalance = 0;
                localStorage.setItem(`earningWallet_${tgUser.id}`, '0');
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert("Successfully moved to main balance!");
            } catch(error) { console.error("Failed to move balance:", error); tg.showAlert("Failed to move balance. Please try again.");
            } finally { btn.textContent = 'Move to Main Balance'; renderUI(); }
        };

        const renderWithdrawalHistory = () => {
            const listEl = document.getElementById('withdrawal-history-list');
            if (userTransactions.length === 0) { listEl.innerHTML = '<p>No withdrawal history found.</p>'; return; }
            listEl.innerHTML = userTransactions.map(item => `
                <div class="history-item">
                    <div class="history-details">
                        <p>${item.amount.toFixed(2)} TK - ${item.method}</p>
                        <small>${new Date(item.timestamp).toLocaleString()}</small>
                    </div>
                    <span class="history-status status-${item.status}">${item.status}</span>
                </div>`).join('');
        };
        
        const setupNavigation = () => {
            const navButtons = document.querySelectorAll('.nav-btn'); const pages = document.querySelectorAll('.page');
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const pageId = button.dataset.page;
                    pages.forEach(page => page.classList.remove('active'));
                    document.getElementById(pageId).classList.add('active');
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    if (pageId === 'profile-page') { renderWithdrawalHistory(); }
                    if (pageId === 'leaderboard-page') { renderLeaderboard(); }
                });
            });
        };
        
        const setupEventListeners = () => {
            popup.addEventListener('click', (e) => { if (e.target.classList.contains('popup-close-btn') || e.target.id === 'popup') closePopup(); });
            document.querySelector('.leaderboard-toggle').addEventListener('click', (e) => {
                if(e.target.classList.contains('toggle-btn')) {
                    document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    renderLeaderboard();
                }
            });
            document.getElementById('dynamic-tasks-container').addEventListener('click', (e) => handleClaimTask(e));
            // Event listener is attached directly to the form now for better handling
            document.getElementById('profile-page').addEventListener('submit', (e) => handleWithdraw(e));
            document.getElementById('referral-section').addEventListener('click', (e) => { if(e.target.id === 'copy-ref-link-btn') copyReferralLink(); });
            document.getElementById('move-to-balance-btn').addEventListener('click', handleMoveToBalance);
        };

        const renderAdTask = () => {
            const container = document.getElementById('ad-task-container');
            const now = Date.now();
            const onBreak = userState.breakUntil && now < userState.breakUntil;
            const limitReached = userState.dailyAdCount >= appConfig.dailyAdLimit;
            let html = '';
            if (onBreak) {
                const remaining = Math.ceil((userState.breakUntil - now) / 60000);
                html = `<div class="task-container"><img class="task-icon-img" src="https://img.icons8.com/ios-filled/100/hourglass.png" alt="icon"><div class="task-info"><h3>Break Time!</h3><p>Please wait for ${remaining} more minutes.</p></div><button class="action-btn" disabled>Waiting</button></div>`;
            } else if (limitReached) {
                html = `<div class="task-container"><img class="task-icon-img" src="https://img.icons8.com/ios-filled/100/stop-circled.png" alt="icon"><div class="task-info"><h3>Daily Limit Reached</h3><p>Come back tomorrow for more ads.</p></div><button class="action-btn" disabled>Limit</button></div>`;
            } else {
                html = `<div class="task-container"><img class="task-icon-img" src="https://img.icons8.com/ios-filled/100/play-button-circled.png" alt="icon"><div class="task-info"><h3>Watch a Rewarded Ad</h3><p>Earn ${appConfig.adValue || 0} TK for every ad.</p></div><button id="watch-ad-btn" class="action-btn">Watch Ad</button></div>`;
            }
            container.innerHTML = html;
            if (!onBreak && !limitReached) { document.getElementById('watch-ad-btn').addEventListener('click', handleWatchAd); }
        };

        const handleClaimTask = async (e) => {
            if (e.target.classList.contains('action-btn') && e.target.dataset.taskId) {
                const taskId = e.target.dataset.taskId;
                const task = appConfig.tasks[taskId];
                if (!task || (userState.completedTasks && userState.completedTasks[taskId])) { tg.showAlert('You have already claimed this bonus.'); return; }
                tg.openLink(e.target.dataset.taskUrl);
                e.target.disabled = true; e.target.textContent = 'Claiming...';
                setTimeout(async () => {
                    try {
                        const db = firebase.database(); const userRef = db.ref(`users/${tgUser.id}`);
                        await userRef.child(`completedTasks/${taskId}`).set(true);
                        await userRef.child('balance').set(firebase.database.ServerValue.increment(task.reward));
                        userState.balance += task.reward;
                        if (!userState.completedTasks) userState.completedTasks = {};
                        userState.completedTasks[taskId] = true;
                        tg.HapticFeedback.notificationOccurred('success');
                        tg.showAlert(`Thank you! You received ${task.reward} bonus TK.`);
                        renderUI();
                    } catch (error) { tg.showAlert('Failed to claim bonus.'); e.target.disabled = false; e.target.textContent = 'Claim Bonus'; }
                }, 5000);
            }
        };

        const handleWithdraw = async (e) => {
            // Ensure this function only runs for the withdraw form
            if(e.target.id !== 'withdraw-form') return;
            e.preventDefault();

            // *** NEW: Minimum referral check ***
            const minRefsRequired = appConfig.minimumWithdrawReferrals || 0;
            const userReferrals = userState.referrals || 0;
            
            if (minRefsRequired > 0 && userReferrals < minRefsRequired) {
                tg.showAlert(`Withdrawal failed. You need at least ${minRefsRequired} referrals to make a withdrawal. You currently have ${userReferrals}.`);
                return; // Stop the function here
            }

            const methodEl = document.getElementById('withdraw-method');
            const accountNumber = document.getElementById('account-number').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const selectedMethod = appConfig.withdrawMethods.find(m => m.name === methodEl.value);
            
            if (isNaN(amount) || amount <= 0) { tg.showAlert("Please enter a valid amount."); return; }
            if (!selectedMethod) { tg.showAlert("Invalid withdrawal method."); return; }
            if (amount < selectedMethod.min) { tg.showAlert(`Minimum withdrawal for ${selectedMethod.name} is ${selectedMethod.min} TK.`); return; }
            if (amount > userState.balance) { tg.showAlert("You don't have enough balance."); return; }
            
            const btn = document.getElementById('withdraw-submit-btn'); btn.disabled = true; btn.textContent = 'Submitting...';
            const db = firebase.database();
            try {
                const userRef = db.ref(`users/${tgUser.id}`);
                // Optimistically update local state for faster UI response
                userState.balance -= amount;
                renderUI(); 
                
                // Perform database operations
                await userRef.child('balance').set(firebase.database.ServerValue.increment(-amount));
                const reqId = db.ref('withdrawals/pending').push().key;
                const newRequest = { id: reqId, userId: tgUser.id, userName: `${userState.firstName} ${userState.lastName}`, method: selectedMethod.name, account: accountNumber, amount: amount, status: 'pending', timestamp: firebase.database.ServerValue.TIMESTAMP };
                await db.ref(`withdrawals/pending/${reqId}`).set(newRequest);
                
                // Add to local history instantly and re-render history
                userTransactions.unshift(newRequest);
                renderWithdrawalHistory(); 

                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert("Withdrawal request submitted successfully!");
                document.getElementById('withdraw-form').reset();
            } catch (error) {
                // If error, revert the optimistic update
                userState.balance += amount;
                tg.HapticFeedback.notificationOccurred('error'); 
                tg.showAlert("Failed to submit request. Your balance has been restored.");
            } finally {
                // Ensure UI is correct and button is re-enabled
                renderUI();
                btn.disabled = false;
                btn.textContent = 'Submit Request';
            }
        };

        const copyReferralLink = () => {
            const refLinkInput = document.getElementById('referral-link');
            refLinkInput.select();
            refLinkInput.setSelectionRange(0, 99999); // For mobile devices
            try {
                navigator.clipboard.writeText(refLinkInput.value).then(() => {
                    tg.HapticFeedback.notificationOccurred('success');
                    tg.showAlert("Referral link copied!");
                });
            } catch (err) {
                // Fallback for older browsers
                document.execCommand('copy');
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert("Referral link copied!");
            }
        };

        const renderLeaderboard = () => {
            const activeBoard = document.querySelector('.toggle-btn.active').dataset.board;
            const listEl = document.getElementById(activeBoard === 'referral' ? 'referral-leaderboard-list' : 'earning-leaderboard-list');
            const data = leaderboardData[activeBoard];
            document.getElementById('referral-board').style.display = activeBoard === 'referral' ? 'block' : 'none';
            document.getElementById('earning-board').style.display = activeBoard === 'earning' ? 'block' : 'none';
            listEl.innerHTML = '';
            if (data.length === 0) { listEl.innerHTML = '<li>No data available.</li>'; return; }
            data.forEach((user, index) => {
                const score = activeBoard === 'referral' ? (user.referrals || 0) : (user.totalEarned || 0).toFixed(2);
                const item = document.createElement('li'); item.className = 'leaderboard-item';
                item.innerHTML = `<span class="rank">#${index + 1}</span><img src="${user.photoUrl || 'https://via.placeholder.com/40'}" alt="User"><span class="leaderboard-name">${user.firstName}</span><span class="leaderboard-score">${score}</span>`;
                listEl.appendChild(item);
            });
        };

        const renderDynamicTasks = () => {
            const container = document.getElementById('dynamic-tasks-container'); container.innerHTML = '';
            if (appConfig.tasks) {
                const tasks = [];
                for(const key in appConfig.tasks) { tasks.push({key, ...appConfig.tasks[key]}); }
                tasks.reverse();
                tasks.forEach(task => {
                    const isCompleted = userState.completedTasks && userState.completedTasks[task.key];
                    const el = document.createElement('div'); el.className = 'task-container';
                    el.innerHTML = `<img class="task-icon-img" src="${task.icon}" alt="icon"><div class="task-info"><h3>${task.name}</h3><p>Get ${task.reward} bonus TK.</p></div><button class="action-btn" data-task-id="${task.key}" data-task-url="${task.url}" ${isCompleted ? 'disabled' : ''}>${isCompleted ? 'Claimed' : 'Claim Bonus'}</button>`;
                    container.appendChild(el);
                });
            }
        };

        const renderReferralSection = () => {
            const container = document.getElementById('referral-section');
            const refLink = `https://t.me/${appConfig.botUsername}/app?startapp=${tgUser.id}`;
            container.innerHTML = `<div class="task-container" style="flex-direction: column; align-items: stretch;"><h3>Refer & Earn More!</h3><p>Invite friends and earn ${appConfig.referralBonus || 0} TK per referral.</p><input type="text" id="referral-link" value="${refLink}" readonly style="padding: 10px; text-align: center; border-radius: 8px; border: 1px dashed var(--primary-color); margin: 10px 0;"><button id="copy-ref-link-btn" class="action-btn">Copy Link</button></div>`;
        };

        const renderWithdrawSection = () => {
            const container = document.getElementById('withdraw-section'); let optionsHtml = '';
            if (appConfig.withdrawMethods) { appConfig.withdrawMethods.forEach(method => { optionsHtml += `<option value="${method.name}">${method.name} (Min: ${method.min} TK)</option>`; }); }
            
            // *** NEW: Add notice about referral requirement ***
            const minRefs = appConfig.minimumWithdrawReferrals || 0;
            let referralNotice = '';
            if (minRefs > 0) {
                referralNotice = `<p style="font-size: 0.85rem; text-align: center; margin-bottom: 15px; opacity: 0.8;"><b>Note:</b> You need at least <b>${minRefs} referrals</b> to be eligible for withdrawal.</p>`;
            }

            container.innerHTML = `<form id="withdraw-form" class="task-container" style="flex-direction: column; align-items: stretch;"><h3>Request Withdraw</h3>${referralNotice}<div class="form-group" style="width:100%"><label for="withdraw-method">Method:</label><select id="withdraw-method" required style="width: 100%; padding: 10px; border-radius: 8px;">${optionsHtml}</select></div><div class="form-group" style="width:100%"><label for="account-number">Account Number/ID:</label><input type="text" id="account-number" required style="width: 100%; padding: 10px; border-radius: 8px;"></div><div class="form-group" style="width:100%"><label for="amount">Amount:</label><input type="number" step="any" id="amount" required style="width: 100%; padding: 10px; border-radius: 8px;"></div><button type="submit" id="withdraw-submit-btn" class="action-btn">Submit Request</button></form>`;
        };

        const renderDynamicLinks = () => {
            const container = document.getElementById('dynamic-links-container'); container.innerHTML = '';
            if (appConfig.links) {
                const links = [];
                for (const key in appConfig.links) { links.push({key, ...appConfig.links[key]}); }
                links.reverse();
                links.forEach(link => {
                    const el = document.createElement('div'); el.className = 'task-container';
                    el.innerHTML = `<img class="task-icon-img" src="${link.icon}" alt="icon"><div class="task-info"><h3>${link.name}</h3></div><button class="action-btn" onclick="window.Telegram.WebApp.openLink('${link.url}')">Visit</button>`;
                    container.appendChild(el);
                });
            }
        };

        initApp();
    });
    </script>
</body>
</html>